# ============================================================
# CGI 242 - Security Scan Workflow
# ============================================================
# Conforme aux recommandations cybersécurité:
# - Scan automatique des vulnérabilités
# - Alertes sur les dépendances compromises
# - Vérification régulière (hebdomadaire + PR)
# ============================================================

name: Security Scan

on:
  # Scan hebdomadaire (lundi 8h UTC)
  schedule:
    - cron: '0 8 * * 1'

  # Scan sur chaque PR vers main
  pull_request:
    branches: [main, master]
    paths:
      - '**/package.json'
      - '**/package-lock.json'

  # Scan manuel
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ==================== NPM AUDIT ====================
  npm-audit:
    name: NPM Vulnerability Scan
    runs-on: ubuntu-latest

    strategy:
      matrix:
        directory: [server, client]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ matrix.directory }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ matrix.directory }}
        run: npm ci

      - name: Run npm audit
        working-directory: ${{ matrix.directory }}
        continue-on-error: true
        run: |
          echo "## NPM Audit - ${{ matrix.directory }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npm audit --omit=dev >> $GITHUB_STEP_SUMMARY 2>&1 || true
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Check for critical vulnerabilities
        working-directory: ${{ matrix.directory }}
        run: |
          # Échouer si vulnérabilités critiques
          CRITICAL=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.critical // 0')
          HIGH=$(npm audit --json 2>/dev/null | jq -r '.metadata.vulnerabilities.high // 0')

          echo "Critical: $CRITICAL, High: $HIGH"

          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::$CRITICAL vulnérabilité(s) critique(s) détectée(s) dans ${{ matrix.directory }}"
            exit 1
          fi

          if [ "$HIGH" -gt 5 ]; then
            echo "::warning::$HIGH vulnérabilité(s) high détectée(s) dans ${{ matrix.directory }}"
          fi

  # ==================== CODE SCANNING ====================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    if: github.event_name != 'schedule'

    permissions:
      security-events: write
      actions: read
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript-typescript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript-typescript"

  # ==================== SECRET SCANNING ====================
  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog Secret Scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified

      - name: Gitleaks Secret Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ==================== DEPENDENCY REVIEW ====================
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: critical
          allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC

  # ==================== REPORT ====================
  security-report:
    name: Generate Security Report
    runs-on: ubuntu-latest
    needs: [npm-audit, secret-scan]
    if: always()

    steps:
      - name: Generate Summary Report
        run: |
          echo "# Security Scan Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Audit | ${{ needs.npm-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "::error::Security scan failed - please review the results"
