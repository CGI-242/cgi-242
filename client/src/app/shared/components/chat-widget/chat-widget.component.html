<!-- Chat popup -->
@if (isOpen()) {
  <div
    class="fixed bottom-6 right-6 w-[400px] h-[600px] max-h-[80vh] bg-white rounded-2xl shadow-2xl flex flex-col z-50 overflow-hidden border border-secondary-200 animate-slide-up">
    <!-- Header -->
    <div class="h-14 bg-primary-600 px-4 flex items-center justify-between flex-shrink-0">
      <div class="flex items-center gap-3">
        <div class="w-8 h-8 bg-white/20 rounded-full flex items-center justify-center">
          <span class="text-white text-xs font-bold">CGI</span>
        </div>
        <div>
          <h3 class="font-medium text-white text-sm">Assistant CGI</h3>
          <p class="text-xs text-white/70">Posez vos questions fiscales</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        @if (messages().length > 0) {
          <button
            (click)="onResetConversation()"
            class="w-8 h-8 hover:bg-white/10 rounded-full flex items-center justify-center transition"
            title="Nouvelle conversation">
            <svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
            </svg>
          </button>
        }
        <button
          (click)="toggleChat()"
          class="w-8 h-8 hover:bg-white/10 rounded-full flex items-center justify-center transition">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Messages -->
    <div #messagesContainer class="flex-1 overflow-y-auto p-4 space-y-4 bg-secondary-50">
      @if (messages().length === 0 && !chatService.isStreaming()) {
        <div class="flex items-center justify-center h-full">
          <div class="text-center">
            <div class="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center mx-auto mb-3">
              <svg class="w-6 h-6 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
              </svg>
            </div>
            <p class="text-sm text-secondary-600">Comment puis-je vous aider ?</p>
          </div>
        </div>
      } @else {
        @for (message of messages(); track message.id) {
          <div class="flex gap-2" [class.flex-row-reverse]="message.role === 'USER'">
            <div
              class="w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0"
              [class.bg-primary-100]="message.role === 'ASSISTANT'"
              [class.bg-primary-600]="message.role === 'USER'">
              @if (message.role === 'ASSISTANT') {
                <span class="text-primary-600 text-[10px] font-bold">CGI</span>
              } @else {
                <span class="text-white text-[10px] font-bold">{{ userInitials() }}</span>
              }
            </div>
            <div class="flex flex-col gap-1 max-w-[80%]">
              <div
                class="rounded-xl px-3 py-2 text-sm"
                [class.bg-primary-600]="message.role === 'USER'"
                [class.text-white]="message.role === 'USER'"
                [class.rounded-tr-none]="message.role === 'USER'"
                [class.bg-white]="message.role === 'ASSISTANT'"
                [class.border]="message.role === 'ASSISTANT'"
                [class.border-secondary-200]="message.role === 'ASSISTANT'"
                [class.rounded-tl-none]="message.role === 'ASSISTANT'">
                @if (message.isVoice && message.role === 'USER') {
                  <span class="text-[10px] opacity-70 block mb-1">Vocal</span>
                }
                <p class="whitespace-pre-wrap">{{ message.content }}</p>
                @if (message.citations && message.citations.length > 0) {
                  <p class="text-[10px] mt-1 opacity-70">Source: CGI {{ message.cgiVersion || '2026' }}</p>
                }
              </div>
              <!-- Bouton lecture vocale pour les réponses -->
              @if (message.role === 'ASSISTANT') {
                <button
                  (click)="speakMessage(message.content)"
                  class="self-start text-xs text-secondary-500 hover:text-primary-600 flex items-center gap-1 transition"
                  [disabled]="voiceService.isSpeaking()"
                  title="Lire à voix haute">
                  @if (voiceService.isSpeaking() && currentSpeakingId === message.id) {
                    <svg class="w-3 h-3 animate-pulse" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6 6h12v12H6z"/>
                    </svg>
                    <span>Arrêter</span>
                  } @else {
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"/>
                    </svg>
                    <span>Ecouter</span>
                  }
                </button>
              }
            </div>
          </div>
        }

        @if (chatService.isStreaming()) {
          <div class="flex gap-2">
            <div class="w-7 h-7 bg-primary-100 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-primary-600 text-[10px] font-bold">CGI</span>
            </div>
            <div class="bg-white border border-secondary-200 rounded-xl rounded-tl-none px-3 py-2 max-w-[80%]">
              @if (chatService.streamingContent()) {
                <p class="whitespace-pre-wrap text-sm" [innerHTML]="formatStreamingContent()"></p>
                <span class="inline-block w-1.5 h-3 bg-primary-600 animate-pulse ml-0.5"></span>
              } @else {
                <div class="flex items-center gap-1.5">
                  <div class="w-1.5 h-1.5 bg-primary-600 rounded-full animate-bounce"></div>
                  <div class="w-1.5 h-1.5 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-1.5 h-1.5 bg-primary-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              }
            </div>
          </div>
        }
      }
    </div>

    <!-- Input -->
    <div class="border-t border-secondary-200 bg-white p-3 flex-shrink-0">
      <!-- Transcription en direct -->
      @if (isListening()) {
        <div class="mb-2 px-3 py-2 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700 flex items-center gap-2">
          <span class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
          <span class="flex-1">{{ liveTranscript() || 'Je vous écoute...' }}</span>
          <button (click)="stopListening()" class="text-red-600 hover:text-red-800">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
      }
      <form (ngSubmit)="onSubmit()" class="flex items-end gap-2">
        <textarea
          [(ngModel)]="messageInput"
          name="message"
          rows="1"
          class="flex-1 resize-none min-h-[40px] max-h-24 px-3 py-2 border border-secondary-300 rounded-xl text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
          placeholder="Votre question..."
          [disabled]="isListening()"
          (keydown.enter)="handleEnterKey($event)"
          (input)="autoResize($event)">
        </textarea>
        <!-- Bouton microphone -->
        <button
          type="button"
          (click)="toggleVoice()"
          [disabled]="chatService.isStreaming()"
          class="h-10 w-10 rounded-xl flex items-center justify-center transition"
          [class.bg-red-500]="isListening()"
          [class.hover:bg-red-600]="isListening()"
          [class.bg-secondary-100]="!isListening()"
          [class.hover:bg-secondary-200]="!isListening()"
          [class.text-white]="isListening()"
          [class.text-secondary-600]="!isListening()"
          title="Recherche vocale">
          @if (isListening()) {
            <div class="flex items-center gap-0.5">
              <span class="w-1 h-3 bg-white rounded-full animate-pulse"></span>
              <span class="w-1 h-4 bg-white rounded-full animate-pulse" style="animation-delay: 0.15s"></span>
              <span class="w-1 h-3 bg-white rounded-full animate-pulse" style="animation-delay: 0.3s"></span>
            </div>
          } @else {
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
            </svg>
          }
        </button>
        <!-- Bouton envoi -->
        <button
          type="submit"
          [disabled]="!messageInput.trim() || chatService.isStreaming() || isListening()"
          class="h-10 w-10 bg-primary-600 hover:bg-primary-700 disabled:bg-secondary-300 text-white rounded-xl flex items-center justify-center transition">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
          </svg>
        </button>
      </form>
    </div>
  </div>
}
